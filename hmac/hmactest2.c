/*
 * @        file: hmactest.c
 * @ description: hmac test tool for below hash algorithms:
 *                1. MD(md2/md4/md5)
 *                2. SHA1(sha1)
 *                3. SHA2(sha224/sha256/sha384/sha512/sha512-224/sha512-256/sha512t)
 *                4. SHA3(sha3-224/sha3-256/sha3-384/sha3-512/shake128/shake256)
 *                5. SM3(sm3)
 * @      author: Gu Yongqiang
 * @        blog: https://blog.csdn.net/guyongqiangx
 */
#include <stdio.h>  /* printf, fopen, fread, fclose... */
#include <stdlib.h> /* exit */
#include <string.h> /* strlen */
#include <unistd.h> /* getopt */

#include "hash.h"
#include "hmac.h"
#include "utils.h"

/*
 * 使用 openssl dgst 命令行工具手工计算数据的 HMAC
 *
 * $ echo -n "0x44, 0x33, 0x22, 0x11, 0x88, 0x77, 0x66, 0x55, 0xbb, 0xaa, 0x00, 0x99, 0xff, 0xee, 0xdd, 0xcc" | xxd -r -ps | openssl dgst -mac HMAC -macopt hexkey:56c9d97c3846f7a425569e352a4fe7d9db4c9bc82f2f5d12530bb3127ccf46cb | awk '{print $2}' | xxd -r -ps | xxd -g 1
 * 0000000: 13 27 05 70 9e a2 12 24 14 0e 61 17 00 57 63 c5  .'.p...$..a..Wc.
 * 0000010: 00 e9 7e 6a 72 45 26 1c 4f 46 ea d5 bb 9e 0e ff  ..~jrE&.OF......
 * $
 * $ echo -n "0x44, 0x33, 0x22, 0x11, 0x88, 0x77, 0x66, 0x55, 0xbb, 0xaa, 0x00, 0x99, 0xff, 0xee, 0xdd, 0xcc" | xxd -r -ps | openssl dgst -mac HMAC -macopt hexkey:56c9d97c3846f7a425569e352a4fe7d9db4c9bc82f2f5d12530bb3127ccf46cb
 * (stdin)= 132705709ea21224140e6117005763c500e97e6a7245261c4f46ead5bb9e0eff
 */
// gcc utils.c md2.c md4.c md5.c sha1.c sha256.c sha512.c sha3.c sha3ex.c sm3.c hash_tables.c hash.c hmac.c hmactest2.c -o hmactest2
int main(int argc, char *argv[])
{
    HASH_ALG alg;
    unsigned int digest_size;
#if 1
   /*
    * SHA1
    * Key length = 64
    * Tag length = 20
    * Input Date: "Sample message for keylen=blocklen"
    * Text is 5361 6D706C65 206D6573 73616765 20666F72 206B6579 6C656E3D 626C6F63 6B6C656E
    *  Key is 00010203 04050607 08090A0B 0C0D0E0F 10111213 14151617 18191A1B 1C1D1E1F 20212223 24252627 28292A2B 2C2D2E2F 30313233 34353637 38393A3B 3C3D3E3F
    *  mac is 5FD596EE 78D5553C 8FF4E72D 266DFD19 2366DA29
    */
    /* "Sample message for keylen=blocklen" */
    unsigned char data[] = {
        0x53, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x66,
        0x6f, 0x72, 0x20, 0x6b, 0x65, 0x79, 0x6c, 0x65, 0x6e, 0x3d, 0x62, 0x6c, 0x6f, 0x63, 0x6b, 0x6c,
        0x65, 0x6e
    };

    unsigned char key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
        0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f,
        0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f,
        0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f
    };

    alg = HASH_ALG_SHA1;
#elif 0
   /*
    * SHA1
    * Key length = 20
    * Tag length = 20
    * Input Date: "Sample message for keylen<blocklen"
    * Text is 5361 6D706C65 206D6573 73616765 20666F72 206B6579 6C656E3C 626C6F63 6B6C656E
    *  Key is 00010203 04050607 08090A0B 0C0D0E0F 10111213
    *  mac is 4C99FF0C B1B31BD3 3F8431DB AF4D17FC D356A807
    */
    /* "Sample message for keylen<blocklen" */
    unsigned char data[] = {
        0x53, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x66,
        0x6f, 0x72, 0x20, 0x6b, 0x65, 0x79, 0x6c, 0x65, 0x6e, 0x3c, 0x62, 0x6c, 0x6f, 0x63, 0x6b, 0x6c,
        0x65, 0x6e
    };

    unsigned char key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
        0x10, 0x11, 0x12, 0x13
    };

    alg = HASH_ALG_SHA1;
#elif 0
   /*
    * SHA1
    * Key length = 100
    * Tag length = 20
    * Input Date: "Sample message for keylen=blocklen"
    * Text is 5361 6D706C65 206D6573 73616765 20666F72 206B6579 6C656E3D 626C6F63 6B6C656E
    *  Key is 00010203 04050607 08090A0B 0C0D0E0F 10111213 14151617 18191A1B 1C1D1E1F 20212223 24252627 28292A2B 2C2D2E2F 30313233 34353637 38393A3B 3C3D3E3F 40414243 44454647 48494A4B 4C4D4E4F 50515253 54555657 58595A5B 5C5D5E5F 60616263
    *  mac is 2D51B2F7 750E4105 84662E38 F133435F 4C4FD42A
    */
    /* "Sample message for keylen=blocklen" */
    unsigned char data[] = {
        0x53, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x66,
        0x6f, 0x72, 0x20, 0x6b, 0x65, 0x79, 0x6c, 0x65, 0x6e, 0x3d, 0x62, 0x6c, 0x6f, 0x63, 0x6b, 0x6c,
        0x65, 0x6e
    };

    unsigned char key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
        0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f,
        0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f,
        0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f,
        0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48, 0x49, 0x4a, 0x4b, 0x4c, 0x4d, 0x4e, 0x4f,
        0x50, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x5a, 0x5b, 0x5c, 0x5d, 0x5e, 0x5f,
        0x60, 0x61, 0x62, 0x63
    };

    alg = HASH_ALG_SHA1;
#elif 1
    /*
     * SHA1
     * Key length = 49
     * Tag length = 12
     * Input Date: "Sample message for keylen<blocklen, with truncated tag"
     * Text is 5361 6D706C65 206D6573 73616765 20666F72 206B6579 6C656E3C 626C6F63 6B6C656E 2C207769 74682074 72756E63 61746564 20746167
     *  Key is 00 01020304 05060708 090A0B0C 0D0E0F10 11121314 15161718 191A1B1C 1D1E1F20 21222324 25262728 292A2B2C 2D2E2F30
     *  mac is FE352956 5CD8E28C 5FA79EAC
     */
    /* "Sample message for keylen<blocklen, with truncated tag" */
    unsigned char data[] = {
        0x53, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x66,
        0x6f, 0x72, 0x20, 0x6b, 0x65, 0x79, 0x6c, 0x65, 0x6e, 0x3c, 0x62, 0x6c, 0x6f, 0x63, 0x6b, 0x6c,
        0x65, 0x6e, 0x2c, 0x20, 0x77, 0x69, 0x74, 0x68, 0x20, 0x74, 0x72, 0x75, 0x6e, 0x63, 0x61, 0x74,
        0x65, 0x64, 0x20, 0x74, 0x61, 0x67
    };

    unsigned char key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
        0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f,
        0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f,
        0x30
    };

    alg = HASH_ALG_SHA1;
#elif 0
    /* SHA256 */
    unsigned char data[] = {
      //0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77, 0x88, 0x99, 0x00, 0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff
        0x44, 0x33, 0x22, 0x11, 0x88, 0x77, 0x66, 0x55, 0xbb, 0xaa, 0x00, 0x99, 0xff, 0xee, 0xdd, 0xcc, 
    };

    unsigned char key[] = {
        0x56, 0xc9, 0xd9, 0x7c, 0x38, 0x46, 0xf7, 0xa4, 0x25, 0x56, 0x9e, 0x35, 0x2a, 0x4f, 0xe7, 0xd9,
        0xdb, 0x4c, 0x9b, 0xc8, 0x2f, 0x2f, 0x5d, 0x12, 0x53, 0x0b, 0xb3, 0x12, 0x7c, 0xcf, 0x46, 0xcb
    };

    alg = HASH_ALG_SHA256;
#else
    /* SHA256 */
    unsigned char data[] = {
        0x49, 0x20, 0x4c, 0x6f, 0x76, 0x65, 0x20, 0x43, 0x68, 0x69, 0x6e, 0x61, 0x21
    };

    unsigned char key[] = {
        0x49, 0x20, 0x4c, 0x6f, 0x76, 0x65, 0x20, 0x43, 0x68, 0x69, 0x6e, 0x61, 0x21
    };

    /*
     * $ echo -n "I Love China!" | openssl dgst -hmac "I Love China!"
     * (stdin)= a1858d82d31d44625cb6218626bc63897f5c5e599b8aa0e06d23c36e9115715f
     */

    alg = HASH_ALG_SHA256;
#endif
    unsigned char buf[256];

    // unsigned char *HMAC(HASH_ALG alg, const void *key, unsigned int key_len, const unsigned char *data, size_t n, unsigned char *md);
    HMAC(alg, key, sizeof(key)/sizeof(key[0]), data, sizeof(data)/sizeof(data[0]), buf);

    printf("data:\n");
    print_buffer(data, sizeof(data)/sizeof(data[0]), "");

    printf(" key:\n");
    print_buffer(key, sizeof(key)/sizeof(key[0]), "");

    printf("HMAC:\n");
    digest_size = HMAC_GetDigestSize(alg, 0);
    print_buffer(buf, digest_size, "");

    return 0;
}